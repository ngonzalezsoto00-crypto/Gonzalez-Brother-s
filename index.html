<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Sistema de Gestión de Producción para Sastrería González Brother's">
    <meta name="theme-color" content="#C9A961">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>SastreControl - González Brother's v3.0.9</title>
    <link rel="stylesheet" href="styles.css?v=3.0.9">
    <link rel="manifest" href="manifest.json">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Firebase SDK (opcional - solo si usas modo Firebase) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <script src="firebase-config.js"></script>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SastreControl">
</head>
<body>
    <!-- Pantalla de Login -->
    <div id="loginScreen" class="screen active">
        <div class="login-container">
            <div class="logo" style="margin-bottom: 30px;">
                <img src="logo.png" alt="González Brother's Sastrería" style="max-width: 400px; width: 90%; height: auto; margin-bottom: 20px; filter: drop-shadow(0 6px 12px rgba(0,0,0,0.25));" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                <div style="display: none; align-items: center; justify-content: center; gap: 15px; margin-bottom: 15px;">
                    <div style="width: 70px; height: 70px; background: linear-gradient(135deg, #1a3a52, #2a5a7c); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.2); border: 3px solid #C9A961;">
                        <span style="font-size: 2.5em;">✂️</span>
                    </div>
                    <div style="text-align: left;">
                        <h1 style="background: linear-gradient(135deg, #1a3a52, #C9A961); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-size: 2em; margin: 0; line-height: 1.2; font-weight: 700; letter-spacing: -1px;">González Brother's</h1>
                        <p style="color: #1a3a52; font-size: 0.75em; margin: 0; font-weight: 500; letter-spacing: 0.5px; text-transform: uppercase;">Sastrería</p>
                    </div>
                </div>
                <p class="subtitle" style="color: #1a3a52; font-weight: 600; font-size: 1em; margin-top: 10px;">SastreControl: Gestión de Producción</p>
            </div>
            
            <div class="role-selection">
                <h2 style="color: #1a3a52; font-size: 1.3em; margin-bottom: 20px; font-weight: 600;">Selecciona tu rol</h2>
                
                <button onclick="selectRole('domiciliario')" class="role-btn domiciliario-btn" style="background: linear-gradient(135deg, #1a3a52, #2a5a7c); border: 2px solid #C9A961; color: white;">
                    <span class="icon">🏍️</span>
                    <span>Domiciliario</span>
                </button>
                <button onclick="selectRole('senalador')" class="role-btn senalador-btn" style="background: linear-gradient(135deg, #1a3a52, #2a5a7c); border: 2px solid #C9A961; color: white;">
                    <span class="icon">📏</span>
                    <span>Señalador</span>
                </button>
                <button onclick="selectRole('sastre')" class="role-btn sastre-btn" style="background: linear-gradient(135deg, #C9A961, #d4b574); border: 2px solid #1a3a52; color: #1a3a52;">
                    <span class="icon">🧵</span>
                    <span>Sastre</span>
                </button>
                <button onclick="selectRole('admin')" class="role-btn admin-btn" style="background: linear-gradient(135deg, #1a3a52, #C9A961); border: 2px solid #C9A961; color: white;">
                    <span class="icon">🛡️</span>
                    <span>Administrador</span>
                </button>
                <button onclick="selectRole('owner')" class="role-btn owner-btn" style="background: linear-gradient(135deg, #C9A961, #d4b574); border: 2px solid #1a3a52; color: #1a3a52; font-weight: 600;">
                    <span class="icon">👑</span>
                    <span>Gerente</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Pantalla de Autenticación -->
    <div id="authScreen" class="screen">
        <div class="auth-container">
            <button onclick="backToLogin()" class="back-btn">← Volver</button>
            <h2 id="authTitle" style="color: #1a3a52; font-size: 1.8em; margin-bottom: 25px; font-weight: 700;">Iniciar Sesión</h2>
            
            <div id="domiciliarioAuth" class="auth-form" style="display: none;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="flex: 1;">
                        <label>Seleccionar Domiciliario:</label>
                        <select id="domiciliarioSelect" style="width: 100%;">
                            <option value="">-- Seleccionar --</option>
                        </select>
                    </div>
                    <button onclick="cargarTrabajadoresSelect('Domiciliario'); return false;" style="margin-top: 22px; padding: 10px 15px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1.2em;" title="Refrescar lista">🔄</button>
                </div>
                <label>PIN:</label>
                <input type="password" id="domiciliarioPin" placeholder="Ingrese su PIN" maxlength="4">
                <button onclick="loginTrabajador('Domiciliario')" class="submit-btn">Ingresar</button>
            </div>

            <div id="senaladorAuth" class="auth-form" style="display: none;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="flex: 1;">
                        <label>Seleccionar Señalador:</label>
                        <select id="senaladorSelect" style="width: 100%;">
                            <option value="">-- Seleccionar --</option>
                        </select>
                    </div>
                    <button onclick="cargarTrabajadoresSelect('Señalador'); return false;" style="margin-top: 22px; padding: 10px 15px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1.2em;" title="Refrescar lista">🔄</button>
                </div>
                <label>PIN:</label>
                <input type="password" id="senaladorPin" placeholder="Ingrese su PIN" maxlength="4">
                <button onclick="loginTrabajador('Señalador')" class="submit-btn">Ingresar</button>
            </div>

            <div id="sastreAuth" class="auth-form" style="display: none;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="flex: 1;">
                        <label>Seleccionar Sastre:</label>
                        <select id="sastreSelect" style="width: 100%;">
                            <option value="">-- Seleccionar --</option>
                        </select>
                    </div>
                    <button onclick="cargarTrabajadoresSelect('Sastre'); return false;" style="margin-top: 22px; padding: 10px 15px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1.2em;" title="Refrescar lista">🔄</button>
                </div>
                <label>PIN:</label>
                <input type="password" id="sastrePin" placeholder="Ingrese su PIN" maxlength="4">
                <button onclick="loginTrabajador('Sastre')" class="submit-btn">Ingresar</button>
            </div>

            <div id="adminAuth" class="auth-form" style="display: none;">
                <label>PIN de Administrador:</label>
                <input type="password" id="adminPin" placeholder="Ingrese PIN">
                <button onclick="loginAdmin()" class="submit-btn">Ingresar</button>
                <p class="hint">PIN predeterminado: 1234</p>
            </div>

            <div id="ownerAuth" class="auth-form" style="display: none;">
                <label>PIN de Gerente:</label>
                <input type="password" id="ownerPin" placeholder="Ingrese PIN">
                <button onclick="loginOwner()" class="submit-btn">Ingresar</button>
                <p class="hint">PIN predeterminado: 0000</p>
            </div>
        </div>
    </div>

    <!-- Dashboard del Domiciliario -->
    <div id="domiciliarioScreen" class="screen">
        <div class="header" style="background: linear-gradient(135deg, #052A3D, #DAA520); border-bottom: 3px solid #DAA520;">
            <h2 style="color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">🏍️ Panel del Domiciliario</h2>
            <div class="user-info">
                <span id="domiciliarioNameDisplay" style="color: white; font-weight: bold;"></span>
                <button onclick="logout()" class="logout-btn" style="background: white; color: #052A3D; border: 2px solid #DAA520;">Salir</button>
            </div>
        </div>

        <div class="info-panel" style="background: linear-gradient(135deg, #052A3D, #DAA520); color: white; padding: 20px; border-radius: 10px; margin: 20px; text-align: center; border: 3px solid #DAA520;">
            <h3 style="margin: 0 0 10px 0; color: white;">📋 Crear Nueva Factura</h3>
            <p style="margin: 0; opacity: 0.9;">Recepción de cliente y registro de trabajo</p>
        </div>

        <div class="recepcion-container" style="padding: 20px; max-width: 1000px; margin: 0 auto;">
            <form onsubmit="registrarFacturaDomiciliario(event)" class="cliente-form" style="background: white; border: 3px solid #052A3D; border-radius: 10px; padding: 25px;">
                <h4 style="color: #052A3D; border-bottom: 3px solid #052A3D; padding-bottom: 8px; margin-bottom: 20px;">👤 Datos del Cliente</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label>Cédula del Cliente: *</label>
                        <input type="text" id="domClienteCedula" placeholder="Ej: 1234567890" required>
                        <button type="button" onclick="buscarClientePorCedulaDom()" class="btn-buscar">� Buscar</button>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Nombre Completo: *</label>
                        <input type="text" id="domClienteNombre" placeholder="Ej: Pedro Ramírez" required>
                    </div>
                    <div class="form-group">
                        <label>Celular: *</label>
                        <input type="tel" id="domClienteCelular" placeholder="Ej: 3001234567" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>Dirección: *</label>
                    <input type="text" id="domClienteDireccion" placeholder="Ej: Calle 123 #45-67" required>
                </div>

                <div class="form-group">
                    <label>Señalador Asignado: *</label>
                    <select id="domSenaladorAsignado" required>
                        <option value="">-- Seleccionar --</option>
                    </select>
                </div>

                <h4 style="color: #DAA520; border-bottom: 3px solid #DAA520; padding-bottom: 8px; margin: 25px 0 20px 0;">✂️ Detalles del Trabajo</h4>

                <div class="form-group">
                    <label>Descripción del Trabajo: *</label>
                    <textarea id="domTrabajoDescripcion" placeholder="Ej: Ajustar pantalón, bajar ruedo..." rows="4" required style="border: 2px solid #052A3D;"></textarea>
                </div>

                <h4 style="color: #052A3D; border-bottom: 3px solid #052A3D; padding-bottom: 8px; margin: 25px 0 20px 0;">� Información de Pago</h4>

                <div class="form-row">
                    <div class="form-group">
                        <label>Precio Total: *</label>
                        <input type="number" id="domPrecioTotal" placeholder="Ej: 50000" step="1000" required>
                    </div>
                    <div class="form-group">
                        <label>Abono: *</label>
                        <input type="number" id="domAbono" placeholder="Ej: 20000" step="1000" value="0" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>Estado de Pago:</label>
                    <select id="domEstadoPago">
                        <option value="pendiente">Pendiente</option>
                        <option value="abonado">Abonado</option>
                        <option value="pagado">Pagado</option>
                    </select>
                </div>

                <button type="submit" class="submit-btn" style="background: linear-gradient(135deg, #052A3D, #DAA520); font-size: 1.2em; padding: 15px; border: 3px solid #DAA520;">✅ Crear Factura</button>
            </form>
        </div>
    </div>

    <!-- Dashboard del Señalador -->
    <div id="senaladorScreen" class="screen">
        <div class="header" style="background: linear-gradient(135deg, #052A3D, #DAA520); border-bottom: 3px solid #DAA520;">
            <h2 style="color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">✂️ Panel del Señalador</h2>
            <div class="user-info">
                <span id="senaladorNameDisplay" style="color: white; font-weight: bold;"></span>
                <button onclick="logout()" class="logout-btn" style="background: white; color: #052A3D; border: 2px solid #DAA520;">Salir</button>
            </div>
        </div>

        <div class="info-panel" style="background: linear-gradient(135deg, #052A3D, #DAA520); color: white; padding: 20px; border-radius: 10px; margin: 20px; text-align: center; border: 3px solid #DAA520;">
            <h3 style="margin: 0 0 10px 0;">� Tu Desempeño del Mes</h3>
            <p style="margin: 0; opacity: 0.9;">Solo visualización de tus facturas asignadas</p>
        </div>

        <div class="stats-senalador" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; padding: 20px;">
            <div class="stat-card-senalador" style="background: linear-gradient(135deg, #052A3D, #8AB4C7); border: 2px solid #052A3D;">
                <h4 style="color: #052A3D;">� Número de Facturas</h4>
                <p class="stat-number" id="totalFacturasSenalador" style="font-size: 3.5em; color: #052A3D; font-weight: bold;">0</p>
                <p style="font-size: 0.9em; color: #666; margin: 5px 0 0 0;">Facturas asignadas</p>
            </div>
            <div class="stat-card-senalador" style="background: linear-gradient(135deg, #DAA520, #FFF9C4); border: 2px solid #DAA520;">
                <h4 style="color: #F57C00;">� Total Acumulado</h4>
                <p class="stat-number" style="font-size: 3.5em; color: #F57C00; font-weight: bold;">$ <span id="totalRecepcionadoSenalador">0</span></p>
                <p style="font-size: 0.9em; color: #666; margin: 5px 0 0 0;">Suma de precios</p>
            </div>
        </div>
    </div>

    <!-- Dashboard del Sastre -->
    <div id="sastreScreen" class="screen">

        <div class="header">
            <h2>Mi Producción Diaria</h2>
            <div class="user-info">
                <span id="sastreNameDisplay"></span>
                <button onclick="logout()" class="logout-btn">Salir</button>
            </div>
        </div>

        <div class="periodo-info">
            <div class="periodo-badge" id="periodoActual">
                <span class="periodo-color"></span>
                <span class="periodo-text"></span>
            </div>
        </div>

        <div class="registro-rapido">
            <h3>Registro de Trabajo</h3>
            <form onsubmit="registrarTrabajoSastre(event)" class="quick-form">
                <div class="form-group">
                    <label>Número de Factura:</label>
                    <input type="text" id="facturaInput" placeholder="Ej: FAC-001" required>
                    <button type="button" onclick="buscarFacturaInfo()" class="btn-buscar">� Buscar</button>
                </div>
                <div id="infoFactura" class="info-factura" style="display: none;">
                    <p><strong>Cliente:</strong> <span id="infoCliente"></span></p>
                    <p><strong>Trabajo:</strong> <span id="infoTrabajo"></span></p>
                    <p><strong>Precio:</strong> $ <span id="infoPrecio"></span></p>
                </div>
                <div class="form-group">
                    <label>¿Es Garantía?</label>
                    <select id="tipoTrabajo">
                        <option value="normal">No - Trabajo Normal</option>
                        <option value="garantia">Sí - Garantía</option>
                    </select>
                </div>
                <div id="garantiaNote" class="form-group" style="display: none;">
                    <label>Nota de Garantía (Obligatorio):</label>
                    <textarea id="notaGarantia" placeholder="¿Qué falló?"></textarea>
                </div>
                <button type="submit" class="submit-btn">✅ Registrar Trabajo Completado</button>
            </form>
        </div>

        <div class="mi-produccion">
            <h3>Mi Producción</h3>
            <div class="stats-grid">
                <div class="stat-card azul">
                    <h4>Azul (1-10)</h4>
                    <p class="stat-number" id="totalAzul">0</p>
                    <p class="stat-label">$ <span id="montoAzul">0.00</span></p>
                </div>
                <div class="stat-card amarillo">
                    <h4>Amarillo (11-20)</h4>
                    <p class="stat-number" id="totalAmarillo">0</p>
                    <p class="stat-label">$ <span id="montoAmarillo">0.00</span></p>
                </div>
                <div class="stat-card verde">
                    <h4>Verde (21-30/31)</h4>
                    <p class="stat-number" id="totalVerde">0</p>
                    <p class="stat-label">$ <span id="montoVerde">0.00</span></p>
                </div>
                <div class="stat-card rojo">
                    <h4>Rojo (Garantía)</h4>
                    <p class="stat-number" id="totalRojo">0</p>
                    <p class="stat-label">$ <span id="montoRojo">0.00</span></p>
                </div>
            </div>

            <div class="total-produccion">
                <h3>Total Mes Actual: $ <span id="totalMesActual">0</span> COP</h3>
            </div>

            <div class="listado-prendas">
                <h4>Historial de Trabajos</h4>
                <div id="listaPrendasSastre" class="tabla-excel"></div>
            </div>
        </div>

        <div class="menu-bottom">
            <button onclick="showHistorial()" class="menu-btn">� Historial Mensual</button>
        </div>
    </div>

    <!-- Dashboard del Administrador -->
    <div id="adminScreen" class="screen">
        <div class="header" style="background: linear-gradient(135deg, #052A3D, #DAA520); border-bottom: 3px solid #DAA520; display: flex; justify-content: space-between; align-items: center; padding: 15px 20px;">
            <h2 style="color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); margin: 0;">🛡️ Panel de Administración</h2>
            <div style="display: flex; gap: 10px; align-items: center;">
                <button onclick="mostrarNotificaciones()" class="icon-btn" style="position: relative; background: rgba(255,255,255,0.2); border: none; color: white; padding: 10px; border-radius: 50%; cursor: pointer; font-size: 1.2em;">
                    🔔
                    <span id="notificationBadge" style="display: none; position: absolute; top: -5px; right: -5px; background: #F44336; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 0.7em; display: flex; align-items: center; justify-content: center; font-weight: bold;">0</span>
                </button>
                <button onclick="toggleModoOscuro()" class="icon-btn" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 10px; border-radius: 50%; cursor: pointer; font-size: 1.2em;">🌙</button>
                <button onclick="logout()" class="logout-btn" style="background: white; color: #052A3D; border: 2px solid #DAA520;">Cerrar Sesión</button>
            </div>
        </div>

        <div class="admin-tabs">
            <button onclick="showAdminTab('crearFactura')" class="tab-btn active" id="tabCrearFactura" style="background: linear-gradient(135deg, #052A3D, #052A3D);">� Recepción</button>
            <button onclick="showAdminTab('facturas')" class="tab-btn" id="tabFacturas">📑 Facturas</button>
            <button onclick="showAdminTab('busquedaAvanzada')" class="tab-btn" id="tabBusquedaAvanzada">🔎 Búsqueda Avanzada</button>
            <button onclick="showAdminTab('dashboard')" class="tab-btn" id="tabDashboard">📈 Dashboard</button>
            <button onclick="showAdminTab('gestionEmpleados')" class="tab-btn" id="tabGestionEmpleados" style="background: linear-gradient(135deg, #DAA520, #FFC107);">� Registro de Trabajadores</button>
            <button onclick="showAdminTab('sastres')" class="tab-btn" id="tabSastres">🧵 Producción Sastres</button>
            <button onclick="showAdminTab('senaladores')" class="tab-btn" id="tabSenaladores">📏 Señaladores</button>
            <button onclick="showAdminTab('liquidacion')" class="tab-btn" id="tabLiquidacion">� Liquidación</button>
            <button onclick="showAdminTab('periodos')" class="tab-btn" id="tabPeriodos">🗓️ Periodos</button>
            <button onclick="showAdminTab('historial')" class="tab-btn" id="tabHistorial">📊 Historial</button>
        </div>

        <!-- Tab: Recepción -->
        <div id="adminTabCrearFactura" class="admin-tab active">
            <h3 style="color: #052A3D; font-size: 1.5em;">� Recepción de Cliente y Creación de Factura</h3>
            <div class="recepcion-container">
                <div style="background: linear-gradient(135deg, #052A3D, #DAA520); color: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: center; border: 3px solid #DAA520;">
                    <h4 style="margin: 0; color: white; font-size: 1.2em;">📝 FORMULARIO DE RECEPCIÓN</h4>
                    <p style="margin: 5px 0 0 0; font-size: 0.9em; opacity: 0.9;">Complete todos los datos del cliente y del trabajo</p>
                </div>
                <form onsubmit="registrarFacturaAdmin(event)" class="cliente-form" style="background: linear-gradient(135deg, #E1F5FE, #FFF9C4); border: 3px solid #DAA520; border-radius: 10px; padding: 25px;">
                    <h4 style="color: #052A3D; border-bottom: 3px solid #052A3D; padding-bottom: 8px; margin-bottom: 20px;">👤 Datos del Cliente</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Cédula del Cliente: *</label>
                            <input type="text" id="adminClienteCedula" placeholder="Ej: 1234567890" required>
                            <button type="button" onclick="buscarClientePorCedulaAdmin()" class="btn-buscar">� Buscar</button>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Nombre Completo: *</label>
                            <input type="text" id="adminClienteNombre" placeholder="Ej: Pedro Ramírez" required>
                        </div>
                        <div class="form-group">
                            <label>Celular: *</label>
                            <input type="tel" id="adminClienteCelular" placeholder="Ej: 3001234567" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Dirección: *</label>
                        <input type="text" id="adminClienteDireccion" placeholder="Ej: Calle 123 #45-67" required>
                    </div>

                    <div class="form-group">
                        <label>Señalador Asignado: *</label>
                        <select id="senaladorAsignado" required>
                            <option value="">-- Seleccionar --</option>
                        </select>
                    </div>

                    <h4 style="color: #DAA520; border-bottom: 3px solid #DAA520; padding-bottom: 8px; margin: 25px 0 20px 0;">✂️ Detalles del Trabajo</h4>

                    <div class="form-group">
                        <label>Descripción del Trabajo: *</label>
                        <textarea id="adminTrabajoDescripcion" placeholder="Ej: Ajustar pantalón a la cintura, bajar ruedo 3cm..." rows="4" required style="border: 2px solid #052A3D;"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>📅️ Fecha de Entrega Estimada:</label>
                        <input type="date" id="adminFechaEntrega" style="border: 2px solid #052A3D;">
                    </div>

                    <h4 style="color: #052A3D; border-bottom: 3px solid #052A3D; padding-bottom: 8px; margin: 25px 0 20px 0;">💰 Información de Pago</h4>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Precio Total: *</label>
                            <input type="number" id="adminPrecioTotal" placeholder="Ej: 50000" step="1000" required>
                        </div>
                        <div class="form-group">
                            <label>Abono: *</label>
                            <input type="number" id="adminAbono" placeholder="Ej: 20000" step="1000" value="0" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Estado de Pago:</label>
                        <select id="adminEstadoPago">
                            <option value="pendiente">Pendiente</option>
                            <option value="abonado">Abonado</option>
                            <option value="pagado">Pagado</option>
                        </select>
                    </div>

                    <button type="submit" class="submit-btn" style="background: linear-gradient(135deg, #052A3D, #DAA520); font-size: 1.2em; padding: 15px; border: 3px solid #DAA520; box-shadow: 0 4px 8px rgba(79, 195, 247, 0.4);">✅ Registrar Recepción y Crear Factura</button>
                </form>
            </div>
        </div>

        <!-- Tab: Gestión de Empleados -->
        <div id="adminTabGestionEmpleados" class="admin-tab">
            <h3 style="color: #052A3D;">� Registro de Trabajadores</h3>
            
            <div class="form-container" style="background: linear-gradient(135deg, #E1F5FE, #FFF9C4); border: 3px solid #DAA520; border-radius: 10px; padding: 20px; margin-bottom: 30px;">
                <h4 style="color: #052A3D;">➕ Registrar Nuevo Trabajador</h4>
                <form onsubmit="agregarEmpleado(event)">
                    <div class="form-group">
                        <label>Nombre Completo del Trabajador: *</label>
                        <input type="text" id="nuevoEmpleadoNombre" required placeholder="Nombre completo">
                    </div>
                    <div class="form-group">
                        <label>Rol del Trabajador: *</label>
                        <select id="nuevoEmpleadoRol" required style="border: 2px solid #052A3D;">
                            <option value="">-- Seleccionar Rol --</option>
                            <option value="Sastre">🧵 Sastre</option>
                            <option value="Domiciliario">🏍️ Domiciliario</option>
                            <option value="Señalador">📏 Señalador</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>PIN de Acceso (4 dígitos): *</label>
                        <input type="password" id="nuevoEmpleadoPin" required placeholder="Ej: 1234" maxlength="4" pattern="[0-9]{4}">
                        <small style="color: #666; display: block; margin-top: 5px;">El trabajador usará este PIN para iniciar sesión</small>
                    </div>
                    <div class="form-group">
                        <label>Cédula:</label>
                        <input type="text" id="nuevoEmpleadoCedula" placeholder="Número de cédula (opcional)">
                    </div>
                    <div class="form-group">
                        <label>Teléfono:</label>
                        <input type="tel" id="nuevoEmpleadoTelefono" placeholder="Teléfono (opcional)">
                    </div>
                    <button type="submit" class="submit-btn" style="background: linear-gradient(135deg, #052A3D, #DAA520); font-size: 1.1em; padding: 12px;">✅ Registrar Trabajador</button>
                </form>
            </div>

            <h4 style="color: #DAA520;">� Lista de Trabajadores Registrados</h4>
            <div id="tablaEmpleadosRegistrados" class="tabla-excel"></div>
        </div>

        <!-- Tab: Facturas -->
        <div id="adminTabFacturas" class="admin-tab">
            <h3>Gestión de Facturas</h3>
            <div class="search-box">
                <input type="text" id="searchFacturasAdmin" placeholder="Buscar por nombre, cédula, celular o # de factura...">
                <button onclick="buscarFacturasAdmin()" class="submit-btn">� Buscar</button>
            </div>
            <div id="tablaFacturasAdmin" class="tabla-excel"></div>
        </div>

        <!-- Tab: Búsqueda Avanzada -->
        <div id="adminTabBusquedaAvanzada" class="admin-tab">
            <h3>� Búsqueda Avanzada de Facturas</h3>
            <div class="filtros-avanzados" style="background: #f5f5f5; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <div class="form-row">
                    <div class="form-group">
                        <label>Número de Factura:</label>
                        <input type="text" id="filtroNumero" placeholder="Ej: FAC-001">
                    </div>
                    <div class="form-group">
                        <label>Nombre del Cliente:</label>
                        <input type="text" id="filtroCliente" placeholder="Ej: Juan Pérez">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Estado de la Prenda:</label>
                        <select id="filtroEstado">
                            <option value="">Todos los estados</option>
                            <option value="Recibida">Recibida</option>
                            <option value="En Proceso">En Proceso</option>
                            <option value="Lista">Lista</option>
                            <option value="Entregada">Entregada</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Sastre:</label>
                        <select id="filtroSastre">
                            <option value="">Todos los sastres</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Fecha Desde:</label>
                        <input type="date" id="filtroFechaInicio">
                    </div>
                    <div class="form-group">
                        <label>Fecha Hasta:</label>
                        <input type="date" id="filtroFechaFin">
                    </div>
                </div>
                <button onclick="busquedaAvanzada()" class="submit-btn" style="width: 100%; margin-top: 15px;">🔍 Buscar</button>
                <button onclick="limpiarFiltros()" class="cancel-btn" style="width: 100%; margin-top: 10px;">🔄 Limpiar Filtros</button>
            </div>
            
            <h4 style="color: #052A3D; margin: 30px 0 15px 0; border-bottom: 2px solid #C9A961; padding-bottom: 10px;">📋 Todas las Facturas</h4>
            <div id="listaTodasFacturas" style="max-height: 600px; overflow-y: auto; background: white; border-radius: 10px; padding: 15px;"></div>
            
            <div id="resultadosBusqueda" class="tabla-excel"></div>
        </div>

        <!-- Tab: Dashboard -->
        <div id="adminTabDashboard" class="admin-tab">
            <h3>📊 Dashboard de Estadísticas</h3>
            <div class="dashboard-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                <div class="stat-card" style="background: linear-gradient(135deg, #2196F3, #64B5F6); color: white; padding: 20px; border-radius: 15px; text-align: center; box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);">
                    <div style="font-size: 2.5em; margin-bottom: 10px;">📋</div>
                    <div id="totalFacturas" style="font-size: 2em; font-weight: bold;">0</div>
                    <div style="font-size: 0.9em; opacity: 0.9;">Facturas Totales</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #4CAF50, #81C784); color: white; padding: 20px; border-radius: 15px; text-align: center; box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);">
                    <div style="font-size: 2.5em; margin-bottom: 10px;">✅</div>
                    <div id="facturasCompletadas" style="font-size: 2em; font-weight: bold;">0</div>
                    <div style="font-size: 0.9em; opacity: 0.9;">Trabajos Completados</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #FF9800, #FFB74D); color: white; padding: 20px; border-radius: 15px; text-align: center; box-shadow: 0 4px 12px rgba(255, 152, 0, 0.3);">
                    <div style="font-size: 2.5em; margin-bottom: 10px;">⏳</div>
                    <div id="facturasEnProceso" style="font-size: 2em; font-weight: bold;">0</div>
                    <div style="font-size: 0.9em; opacity: 0.9;">En Proceso</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #9C27B0, #BA68C8); color: white; padding: 20px; border-radius: 15px; text-align: center; box-shadow: 0 4px 12px rgba(156, 39, 176, 0.3);">
                    <div style="font-size: 2.5em; margin-bottom: 10px;">💰</div>
                    <div id="ingresosMes" style="font-size: 1.5em; font-weight: bold;">$0</div>
                    <div style="font-size: 0.9em; opacity: 0.9;">Ingresos del Mes</div>
                </div>
            </div>
            
            <div class="ranking-section" style="background: white; padding: 20px; border-radius: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <h4 style="color: #052A3D; margin-bottom: 15px;">🏆 Ranking de Sastres del Mes</h4>
                <div id="rankingSastres"></div>
            </div>
            
            <div class="grafico-section" style="margin-top: 30px; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <h4 style="color: #052A3D; margin-bottom: 15px;">📈 Producción de los Últimos 6 Meses</h4>
                <canvas id="graficoProduccion" style="max-height: 300px;"></canvas>
            </div>
        </div>

        <!-- Tab: Señaladores -->
        <div id="adminTabSenaladores" class="admin-tab">
            <h3>Producción de Señaladores</h3>
            <div id="listaSenaladores" class="tabla-excel"></div>
        </div>

        <!-- Tab: Sastres -->
        <div id="adminTabSastres" class="admin-tab">
            <h3>Producción por Sastre</h3>
            
            <div class="periodo-tabs">
                <button class="periodo-tab active" onclick="showPeriodoTab('azul')" id="tabPeriodoAzul">
                    <span class="color-indicator" style="background: #2196F3;"></span>
                    Azul (1-10)
                </button>
                <button class="periodo-tab" onclick="showPeriodoTab('amarillo')" id="tabPeriodoAmarillo">
                    <span class="color-indicator" style="background: #FFC107;"></span>
                    Amarillo (11-20)
                </button>
                <button class="periodo-tab" onclick="showPeriodoTab('verde')" id="tabPeriodoVerde">
                    <span class="color-indicator" style="background: #4CAF50;"></span>
                    Verde (21-30/31)
                </button>
                <button class="periodo-tab" onclick="showPeriodoTab('rojo')" id="tabPeriodoRojo">
                    <span class="color-indicator" style="background: #F44336;"></span>
                    Garantías
                </button>
                <button class="periodo-tab" onclick="showPeriodoTab('todos')" id="tabPeriodoTodos">
                    📊 Todos
                </button>
            </div>

            <div id="periodoAzul" class="periodo-content active">
                <div class="tabla-excel" id="tablaAzul"></div>
            </div>
            <div id="periodoAmarillo" class="periodo-content">
                <div class="tabla-excel" id="tablaAmarillo"></div>
            </div>
            <div id="periodoVerde" class="periodo-content">
                <div class="tabla-excel" id="tablaVerde"></div>
            </div>
            <div id="periodoRojo" class="periodo-content">
                <div class="tabla-excel" id="tablaRojo"></div>
            </div>
            <div id="periodoTodos" class="periodo-content">
                <div class="tabla-excel" id="tablaTodos"></div>
            </div>
        </div>

        <!-- Tab: Liquidación -->
        <div id="adminTabLiquidacion" class="admin-tab">
            <h3>💰 Liquidación y Nómina</h3>
            
            <div class="trabajador-selector">
                <label>Seleccionar Trabajador:</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <select id="trabajadorSelectLiquidacion" onchange="calcularLiquidacion()" style="flex: 1;">
                        <option value="">-- Seleccionar Trabajador --</option>
                    </select>
                    <button onclick="cargarTodosLosTrabjadoresLiquidacion()" style="padding: 10px 15px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">🔄</button>
                </div>
            </div>

            <div id="liquidacionPanel" style="display: none;">
                <!-- Info del Trabajador -->
                <div class="liquidacion-card" style="background: linear-gradient(135deg, #E3F2FD, #FFF9C4); border: 2px solid #DAA520; margin-bottom: 20px;">
                    <h4>👤 Información del Trabajador</h4>
                    <p><strong>Nombre:</strong> <span id="trabajadorNombre"></span></p>
                    <p><strong>Rol:</strong> <span id="trabajadorRol"></span></p>
                    <p><strong>Periodo:</strong> <span id="trabajadorPeriodo"></span></p>
                </div>

                <!-- Cálculo según Rol -->
                <div id="calculoSastre" class="liquidacion-card" style="display: none;">
                    <h4>👔 Producción de Sastre</h4>
                    <p><strong>Total Producido:</strong> $ <span id="sastreTotalProducido">0</span> COP</p>
                    <p><strong>Porcentaje Sastre:</strong> <span id="sastrePorcentaje">40</span>%</p>
                    <p class="amount-display">Suma Bruta = $ <span id="sastreSumaBruta">0</span> COP</p>
                </div>

                <div id="calculoSenalador" class="liquidacion-card" style="display: none;">
                    <h4>📏 Trabajo de Señalador</h4>
                    <p><strong>Total Recepcionado en Sede:</strong> $ <span id="senaladorTotalRecepcionado">0</span> COP</p>
                    <p><strong>Porcentaje Señalador:</strong> <span id="senaladorPorcentaje">11</span>%</p>
                    <p class="amount-display">Suma Bruta = $ <span id="senaladorSumaBruta">0</span> COP</p>
                </div>

                <div id="calculoDomiciliario" class="liquidacion-card" style="display: none;">
                    <h4>🚗 Trabajo de Domiciliario</h4>
                    <p><strong>Total Recepcionado:</strong> $ <span id="domiciliarioTotalRecepcionado">0</span> COP</p>
                    <p><strong>Porcentaje por Recepción:</strong> <span id="domiciliarioPorcentaje">11</span>%</p>
                    <p><strong>Subtotal Recepción:</strong> $ <span id="domiciliarioSubtotalRecepcion">0</span> COP</p>
                    <p style="margin-top: 10px;"><strong>Domicilios Realizados:</strong> <span id="domiciliosCantidad">0</span></p>
                    <p><strong>Pago por Domicilio:</strong> $ <span id="domicilioPagoUnitario">20,000</span> COP</p>
                    <p><strong>Subtotal Domicilios:</strong> $ <span id="domicilioSubtotalDomicilios">0</span> COP</p>
                    <p class="amount-display">Suma Bruta = $ <span id="domiciliarioSumaBruta">0</span> COP</p>
                </div>

                <!-- Deducciones -->
                <div class="deducciones-panel">
                    <h4>➖ Deducciones</h4>
                    <div class="form-group">
                        <label>Salud (<span id="displaySalud">4</span>%):</label>
                        <input type="number" id="porcentajeSalud" value="4" step="0.01" oninput="calcularLiquidacion()">
                        <p class="calculated">= $ <span id="montoSalud">0</span> COP</p>
                    </div>
                    <div class="form-group">
                        <label>Pensión (<span id="displayPension">4</span>%):</label>
                        <input type="number" id="porcentajePension" value="4" step="0.01" oninput="calcularLiquidacion()">
                        <p class="calculated">= $ <span id="montoPension">0</span> COP</p>
                    </div>
                    <div class="form-group">
                        <label>Préstamos ($):</label>
                        <input type="number" id="montoPrestamo" value="0" step="1000" oninput="calcularLiquidacion()">
                    </div>
                    <div class="form-group">
                        <label>Otros Descuentos ($):</label>
                        <input type="number" id="otrosDescuentos" value="0" step="1000" oninput="calcularLiquidacion()">
                        <input type="text" id="conceptoOtros" placeholder="Concepto" style="margin-top: 5px;">
                    </div>
                    <div class="form-group" style="background: #FFEBEE; padding: 10px; border-radius: 5px; margin-top: 10px;">
                        <p><strong>Total Deducciones:</strong> $ <span id="totalDeducciones">0</span> COP</p>
                    </div>
                </div>

                <!-- Pago Neto -->
                <div class="pago-neto-card" style="background: linear-gradient(135deg, #4CAF50, #8BC34A); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                    <h4 style="color: white;">💵 PAGO NETO</h4>
                    <p class="amount-display final" style="font-size: 2em; font-weight: bold; color: white;">$ <span id="pagoNeto">0</span> COP</p>
                </div>

                <button onclick="generarVolante()" class="submit-btn" style="background: linear-gradient(135deg, #052A3D, #DAA520); margin-top: 20px;">📄 Generar Volante (TXT)</button>
                <button onclick="exportarVolantePDF()" class="submit-btn" style="background: linear-gradient(135deg, #F44336, #E91E63); margin-top: 10px;">📑 Descargar Volante (PDF)</button>
            </div>
        </div>

        <!-- Tab: Periodos -->
        <div id="adminTabPeriodos" class="admin-tab">
            <h3>Gestión de Periodos</h3>
            <div class="periodo-actual-info">
                <h4>Periodo Actual</h4>
                <div id="periodoActualAdmin"></div>
            </div>

            <div class="periodos-cerrados">
                <h4>Periodos Cerrados</h4>
                <div id="periodosCerradosList"></div>
            </div>

            <button onclick="cerrarPeriodoActual()" class="submit-btn danger">Cerrar Periodo Actual</button>
        </div>

        <!-- Tab: Historial -->
        <div id="adminTabHistorial" class="admin-tab">
            <h3>Historial Mensual</h3>
            <div id="historialAdminPanel"></div>
        </div>
    </div>

    <!-- Dashboard del Gerente -->
    <div id="ownerScreen" class="screen">
        <div class="header" style="background: linear-gradient(135deg, #DAA520, #FFA000); border-bottom: 3px solid #052A3D;">
            <h2 style="color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">👑 Panel del Gerente</h2>
            <button onclick="logout()" class="logout-btn" style="background: white; color: #DAA520; border: 2px solid #052A3D;">Cerrar Sesión</button>
        </div>

        <div class="stats-overview">
            <h3>Estadísticas Generales</h3>
            <div class="stats-grid-owner">
                <div class="stat-card-owner">
                    <h4>Producción Total Mes</h4>
                    <p class="stat-number-owner">$ <span id="produccionTotalMes">0</span></p>
                </div>
                <div class="stat-card-owner">
                    <h4>Total Sastres Activos</h4>
                    <p class="stat-number-owner"><span id="sastresActivos">0</span></p>
                </div>
                <div class="stat-card-owner">
                    <h4>Garantías del Mes</h4>
                    <p class="stat-number-owner"><span id="garantiasMes">0</span></p>
                </div>
                <div class="stat-card-owner">
                    <h4>Prendas Procesadas</h4>
                    <p class="stat-number-owner"><span id="prendasMes">0</span></p>
                </div>
            </div>
        </div>

        <div class="owner-sections">
            <button onclick="showOwnerSection('reportes')" class="owner-tab-btn">📈 Reportes</button>
            <button onclick="showOwnerSection('configuracion')" class="owner-tab-btn">⚙️ Configuración</button>
            <button onclick="showOwnerSection('historial')" class="owner-tab-btn">📊 Historial</button>
        </div>

        <div id="ownerReportes" class="owner-section active">
            <h3>Reportes Detallados</h3>
            <div id="reportesSastres"></div>
        </div>

        <div id="ownerConfiguracion" class="owner-section">
            <h3>Configuración del Sistema</h3>
            
            <!-- Panel de configuración de sincronización -->
            <div style="margin-bottom: 30px; padding: 20px; background: #fff3cd; border-radius: 10px; border: 2px solid #DAA520;">
                <h4 style="color: #052A3D; margin-top: 0; font-size: 1.2em;">☁️ Configuración de Sincronización</h4>
                <p style="color: #666; margin-bottom: 15px;">Configura cómo se sincronizan los datos entre dispositivos</p>
                <select id="modoSincronizacion" onchange="configurarSincronizacion()" style="width: 100%; padding: 10px; font-size: 1em; border: 2px solid #052A3D; border-radius: 5px;">
                    <option value="local">💾 Solo este dispositivo (sin sincronización)</option>
                    <option value="firebase">☁️ Sincronización en la nube (Firebase)</option>
                    <option value="servidor">🌐 Sincronización en red local (Servidor)</option>
                </select>
                <div id="configServidor" style="display: none; margin-top: 10px;">
                    <input type="text" id="servidorURL" placeholder="http://192.168.1.X:3000" style="width: 100%; padding: 8px; border: 2px solid #052A3D; border-radius: 5px;">
                    <button onclick="probarConexion()" style="margin-top: 5px; padding: 8px 15px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">🔌 Probar Conexión</button>
                </div>
                <p id="estadoSync" style="margin: 10px 0 0 0; font-size: 0.9em; color: #666;"></p>
            </div>
            
            <hr style="margin: 30px 0; border: 1px solid #ddd;">
            
            <div class="config-panel">
                <div class="form-group">
                    <label>🏢 Nombre de esta Sede:</label>
                    <input type="text" id="configNombreSede" value="Sede Principal" placeholder="Ej: Sede 1, Sede Norte">
                    <small style="color: #666; display: block; margin-top: 5px;">Identifica esta sede/tienda para futura sincronización</small>
                </div>
                <div class="form-group">
                    <label>PIN Administrador:</label>
                    <input type="password" id="configAdminPin" value="1234">
                </div>
                <div class="form-group">
                    <label>PIN Gerente:</label>
                    <input type="password" id="configOwnerPin" value="0000">
                </div>
                <div class="form-group">
                    <label>% Salud Predeterminado:</label>
                    <input type="number" id="configSalud" value="4" step="0.01">
                </div>
                <div class="form-group">
                    <label>% Pensión Predeterminado:</label>
                    <input type="number" id="configPension" value="4" step="0.01">
                </div>
                
                <hr style="margin: 30px 0; border: 1px solid #ddd;">
                
                <h4 style="color: #052A3D; margin-bottom: 15px;">💰 Configuración de Liquidación</h4>
                <p style="color: #666; margin-bottom: 15px;">Define los porcentajes y valores para el cálculo de nómina de cada rol.</p>
                
                <div class="form-group">
                    <label>👔 % Sastre (sobre su producción):</label>
                    <input type="number" id="configPorcentajeSastre" value="40" step="0.01" min="0" max="100">
                    <small style="color: #666;">El sastre recibe este porcentaje de su producción total</small>
                </div>
                
                <div class="form-group">
                    <label>📏 % Señalador (sobre total recepcionado en sede):</label>
                    <input type="number" id="configPorcentajeSenalador" value="11" step="0.01" min="0" max="100">
                    <small style="color: #666;">El señalador recibe este porcentaje del total recepcionado</small>
                </div>
                
                <div class="form-group">
                    <label>🚗 % Domiciliario (sobre lo que recepciona):</label>
                    <input type="number" id="configPorcentajeDomiciliario" value="11" step="0.01" min="0" max="100">
                    <small style="color: #666;">El domiciliario recibe este porcentaje de lo que él recepciona</small>
                </div>
                
                <div class="form-group">
                    <label>🏍️ Pago por Domicilio ($):</label>
                    <input type="number" id="configPagoPorDomicilio" value="20000" step="1000" min="0">
                    <small style="color: #666;">Valor que se paga al domiciliario por cada domicilio realizado</small>
                </div>
                
                <button onclick="guardarConfiguracion()" class="submit-btn" style="background: linear-gradient(135deg, #052A3D, #DAA520);">Guardar Configuración</button>
                
                <hr style="margin: 30px 0; border: 1px solid #ddd;">
                
                <h4 style="color: #052A3D; margin-bottom: 15px;">💾 Gestión de Datos y Respaldos</h4>
                <p style="color: #666; margin-bottom: 15px;">Los datos se guardan automáticamente en el navegador y se crean respaldos automáticos cada 5 minutos.</p>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 20px;">
                    <button onclick="exportarDatos()" class="submit-btn" style="background: #4CAF50;">
                        📥 Exportar Datos
                    </button>
                    <button onclick="importarDatos()" class="submit-btn" style="background: #2196F3;">
                        📤 Importar Datos
                    </button>
                    <button onclick="restaurarRespaldo()" class="submit-btn" style="background: #FF9800;">
                        🔄 Restaurar Respaldo
                    </button>
                    <button onclick="mostrarInfoRespaldo()" class="submit-btn" style="background: #9C27B0;">
                        ℹ️ Info Respaldo
                    </button>
                </div>
                
                <div id="infoRespaldo" style="margin-top: 15px; padding: 15px; background: #f5f5f5; border-radius: 8px; display: none;">
                    <p style="margin: 5px 0;"><strong>Último respaldo automático:</strong> <span id="fechaRespaldo">N/A</span></p>
                    <p style="margin: 5px 0; color: #666; font-size: 0.9em;">El sistema crea respaldos automáticos cada 5 minutos mientras la app está abierta.</p>
                    <p style="margin: 5px 0; color: #666; font-size: 0.9em;">Se recomienda exportar datos periódicamente como respaldo externo.</p>
                </div>
            </div>
        </div>

        <div id="ownerHistorial" class="owner-section">
            <h3>Historial Mensual Completo</h3>
            <div id="historialOwnerPanel"></div>
        </div>
    </div>

    <!-- Modal de Historial -->
    <div id="historialModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Historial Mensual</h2>
                <button onclick="closeHistorial()" class="close-btn">✕</button>
            </div>
            <div class="modal-body">
                <div id="historialContent"></div>
            </div>
        </div>
    </div>

    <!-- Modal de Vista Previa de Factura -->
    <div id="facturaModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px; background: white; border-radius: 15px; overflow: hidden;">
            <div class="modal-header" style="background: linear-gradient(135deg, #1a3a52, #2d5a7b); color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center;">
                <h2 style="margin: 0; color: white;">📄 Vista Previa - Factura</h2>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <button onclick="descargarFacturaActual()" class="icon-btn" style="background: rgba(255,255,255,0.15); color: white; border: none; font-size: 20px; cursor: pointer; width: 38px; height: 38px; border-radius: 50%; transition: all 0.3s; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.background='rgba(76,175,80,0.8)'; this.title='Descargar';" onmouseout="this.style.background='rgba(255,255,255,0.15)';" title="Descargar">📥</button>
                    <button onclick="imprimirFacturaActual()" class="icon-btn" style="background: rgba(255,255,255,0.15); color: white; border: none; font-size: 20px; cursor: pointer; width: 38px; height: 38px; border-radius: 50%; transition: all 0.3s; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.background='rgba(33,150,243,0.8)'; this.title='Imprimir';" onmouseout="this.style.background='rgba(255,255,255,0.15)';" title="Imprimir">🖨️</button>
                    <button onclick="cerrarModalFactura()" class="close-btn" style="background: rgba(255,255,255,0.15); color: white; border: none; font-size: 22px; cursor: pointer; width: 38px; height: 38px; border-radius: 50%; transition: all 0.3s; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.background='rgba(244,67,54,0.8)';" onmouseout="this.style.background='rgba(255,255,255,0.15)';" title="Cerrar">✕</button>
                </div>
            </div>
            <div class="modal-body" style="padding: 0;">
                <div id="facturaPreview" style="background: #f9f9f9; padding: 20px; font-family: 'Courier New', monospace; font-size: 13px; line-height: 1.5; white-space: pre-wrap; max-height: 450px; overflow-y: auto;"></div>
            </div>
        </div>
    </div>

    <!-- Botón de Ayuda / Chatbot -->
    <style>
        @keyframes pulseGlow {
            0%, 100% {
                box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4), 0 0 0 0 rgba(76, 175, 80, 0.7);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 4px 20px rgba(76, 175, 80, 0.6), 0 0 0 10px rgba(76, 175, 80, 0);
                transform: scale(1.05);
            }
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }
        
        #btnAyuda {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 65px;
            height: 65px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 50%, #66BB6A 100%);
            color: white;
            border: none;
            font-size: 32px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
            z-index: 9999;
            animation: pulseGlow 2s infinite ease-in-out;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        
        #btnAyuda:hover {
            animation: bounce 0.6s ease;
            background: linear-gradient(135deg, #66BB6A 0%, #4CAF50 50%, #45a049 100%);
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 8px 20px rgba(76, 175, 80, 0.6);
        }
        
        #btnAyuda:active {
            transform: scale(0.95);
        }
        
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .chatbot-show {
            animation: slideInUp 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        
        .ayuda-btn {
            transition: all 0.3s ease;
        }
        
        .ayuda-btn:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
        }
        
        .chatbot-tab-btn {
            transition: all 0.3s ease;
        }
        
        .chatbot-tab-btn:hover {
            background: #f0f0f0 !important;
        }
    </style>
    <button id="btnAyuda" onclick="toggleChatbot()">🤖</button>

    <!-- Panel de Chatbot -->
    <div id="chatbotPanel" style="display: none; position: fixed; bottom: 100px; right: 20px; width: 360px; max-width: 90vw; height: 520px; max-height: 75vh; background: linear-gradient(to bottom, #ffffff 0%, #f8f9fa 100%); border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.25), 0 0 0 1px rgba(0,0,0,0.05); z-index: 9998; flex-direction: column; overflow: hidden;">
        <div style="background: linear-gradient(135deg, #1a5f7a 0%, #159895 50%, #57c5b6 100%); color: white; padding: 18px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
            <h3 style="margin: 0; font-size: 1.2em; font-weight: 600; display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 1.5em; animation: bounce 1s infinite;">🤖</span>
                Asistente Virtual
            </h3>
            <button onclick="toggleChatbot()" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 20px; cursor: pointer; width: 32px; height: 32px; border-radius: 50%; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.background='rgba(255,255,255,0.3)'; this.style.transform='rotate(90deg)';" onmouseout="this.style.background='rgba(255,255,255,0.2)'; this.style.transform='rotate(0deg)';">✕</button>
        </div>
        
        <div class="chatbot-tabs" style="display: flex; background: linear-gradient(to bottom, #f8f9fa, #e9ecef); box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
            <button onclick="showChatbotTab('ayuda')" id="tabChatAyuda" class="chatbot-tab-btn active" style="flex: 1; padding: 14px; border: none; background: white; cursor: pointer; font-weight: 600; font-size: 0.95em; border-bottom: 3px solid #159895; color: #1a5f7a;">❓ Ayuda</button>
            <button onclick="showChatbotTab('sugerencias')" id="tabChatSugerencias" class="chatbot-tab-btn" style="flex: 1; padding: 14px; border: none; background: transparent; cursor: pointer; font-weight: 600; font-size: 0.95em; color: #666;">💡 Sugerencias</button>
        </div>
        
        <!-- Tab Ayuda -->
        <div id="chatTabAyuda" class="chatbot-tab" style="flex: 1; overflow-y: auto; padding: 18px;">
            <h4 style="color: #1a5f7a; margin-top: 0; font-size: 1.1em; font-weight: 600; margin-bottom: 15px;">¿En qué puedo ayudarte? 😊</h4>
            <div class="ayuda-opciones">
                <button onclick="mostrarAyuda('login')" class="ayuda-btn" style="width: 100%; padding: 14px 16px; margin: 10px 0; background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%); border: 2px solid #2196F3; border-radius: 12px; cursor: pointer; text-align: left; font-weight: 600; font-size: 0.95em; color: #1565C0; box-shadow: 0 2px 5px rgba(33, 150, 243, 0.2);">🔐 ¿Cómo iniciar sesión?</button>
                <button onclick="mostrarAyuda('registrar')" class="ayuda-btn" style="width: 100%; padding: 14px 16px; margin: 10px 0; background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%); border: 2px solid #4CAF50; border-radius: 12px; cursor: pointer; text-align: left; font-weight: 600; font-size: 0.95em; color: #2E7D32; box-shadow: 0 2px 5px rgba(76, 175, 80, 0.2);">➕ ¿Cómo registrar trabajadores?</button>
                <button onclick="mostrarAyuda('factura')" class="ayuda-btn" style="width: 100%; padding: 14px 16px; margin: 10px 0; background: linear-gradient(135deg, #FFF3E0 0%, #FFE0B2 100%); border: 2px solid #FF9800; border-radius: 12px; cursor: pointer; text-align: left; font-weight: 600; font-size: 0.95em; color: #E65100; box-shadow: 0 2px 5px rgba(255, 152, 0, 0.2);">📋 ¿Cómo crear una factura?</button>
                <button onclick="mostrarAyuda('liquidacion')" class="ayuda-btn" style="width: 100%; padding: 14px 16px; margin: 10px 0; background: linear-gradient(135deg, #F3E5F5 0%, #E1BEE7 100%); border: 2px solid #9C27B0; border-radius: 12px; cursor: pointer; text-align: left; font-weight: 600; font-size: 0.95em; color: #6A1B9A; box-shadow: 0 2px 5px rgba(156, 39, 176, 0.2);">💰 ¿Cómo calcular liquidación?</button>
                <button onclick="mostrarAyuda('respaldo')" class="ayuda-btn" style="width: 100%; padding: 14px 16px; margin: 10px 0; background: linear-gradient(135deg, #E0F2F1 0%, #B2DFDB 100%); border: 2px solid #009688; border-radius: 12px; cursor: pointer; text-align: left; font-weight: 600; font-size: 0.95em; color: #00695C; box-shadow: 0 2px 5px rgba(0, 150, 136, 0.2);">💾 ¿Cómo hacer respaldos?</button>
                <button onclick="mostrarAyuda('pin')" class="ayuda-btn" style="width: 100%; padding: 14px 16px; margin: 10px 0; background: linear-gradient(135deg, #FFEBEE 0%, #FFCDD2 100%); border: 2px solid #F44336; border-radius: 12px; cursor: pointer; text-align: left; font-weight: 600; font-size: 0.95em; color: #C62828; box-shadow: 0 2px 5px rgba(244, 67, 54, 0.2);">🔑 Olvidé mi PIN</button>
            </div>
            <div id="ayudaRespuesta" style="margin-top: 20px; padding: 18px; background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%); border-radius: 12px; display: none; border-left: 4px solid #159895; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"></div>
        </div>
        
        <!-- Tab Sugerencias -->
        <div id="chatTabSugerencias" class="chatbot-tab" style="display: none; flex: 1; overflow-y: auto; padding: 18px;">
            <h4 style="color: #1a5f7a; margin-top: 0; font-size: 1.1em; font-weight: 600;">💡 Envía tus Sugerencias</h4>
            <p style="color: #666; font-size: 0.9em; line-height: 1.5;">Ayúdanos a mejorar la aplicación con tus ideas y comentarios.</p>
            <form onsubmit="enviarSugerencia(event)" style="display: flex; flex-direction: column; gap: 12px;">
                <div>
                    <label style="font-weight: bold; display: block; margin-bottom: 5px;">Tu Nombre:</label>
                    <input type="text" id="sugerenciaNombre" placeholder="Nombre (opcional)" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                </div>
                <div>
                    <label style="font-weight: bold; display: block; margin-bottom: 5px;">Tipo:</label>
                    <select id="sugerenciaTipo" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        <option value="mejora">🔧 Mejora</option>
                        <option value="error">🐛 Reportar Error</option>
                        <option value="nueva">✨ Nueva Funcionalidad</option>
                        <option value="otro">💭 Otro</option>
                    </select>
                </div>
                <div>
                    <label style="font-weight: bold; display: block; margin-bottom: 5px;">Mensaje: *</label>
                    <textarea id="sugerenciaTexto" required placeholder="Describe tu sugerencia o problema..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; min-height: 100px; resize: vertical;"></textarea>
                </div>
                <button type="submit" style="padding: 12px; background: linear-gradient(135deg, #4CAF50, #8BC34A); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">📤 Enviar Sugerencia</button>
            </form>
            <div id="sugerenciasGuardadas" style="margin-top: 20px;">
                <h5>📋 Sugerencias Recientes:</h5>
                <div id="listaSugerencias" style="max-height: 150px; overflow-y: auto;"></div>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        // LIMPIEZA AUTOMÁTICA DE CACHÉ AL DETECTAR NUEVA VERSIÓN
        const VERSION_ACTUAL = '3.2.2';
        const versionGuardada = localStorage.getItem('app_version');
        
        console.log('📌 Versión actual del código: ' + VERSION_ACTUAL);
        console.log('📌 Versión guardada en dispositivo: ' + versionGuardada);
        
        if (versionGuardada !== VERSION_ACTUAL) {
            console.log('🔄 ACTUALIZANDO DE ' + versionGuardada + ' A ' + VERSION_ACTUAL);
            
            // Crear banner de actualización visible
            const banner = document.createElement('div');
            banner.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; background: linear-gradient(135deg, #4CAF50, #66BB6A); color: white; padding: 15px; text-align: center; z-index: 99999; font-size: 16px; font-weight: bold; box-shadow: 0 4px 12px rgba(0,0,0,0.3);';
            banner.innerHTML = '🔄 ACTUALIZANDO A VERSIÓN ' + VERSION_ACTUAL + '... Por favor espere...';
            document.body.insertBefore(banner, document.body.firstChild);
            
            // Desregistrar todos los Service Workers
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(registrations => {
                    console.log('🗑️ Encontrados ' + registrations.length + ' Service Workers');
                    registrations.forEach(reg => {
                        console.log('🗑️ Desregistrando SW...');
                        reg.unregister();
                    });
                });
            }
            
            // Limpiar todos los cachés
            if ('caches' in window) {
                caches.keys().then(names => {
                    console.log('🗑️ Encontrados ' + names.length + ' cachés');
                    names.forEach(name => {
                        console.log('🗑️ Eliminando cache:', name);
                        caches.delete(name);
                    });
                });
            }
            
            // Guardar nueva versión
            localStorage.setItem('app_version', VERSION_ACTUAL);
            console.log('✅ Nueva versión guardada: ' + VERSION_ACTUAL);
            
            // Recargar si había una versión anterior
            if (versionGuardada) {
                setTimeout(() => {
                    console.log('🔄 Recargando aplicación...');
                    window.location.reload(true);
                }, 2000);
            } else {
                banner.innerHTML = '✅ Aplicación instalada - Versión ' + VERSION_ACTUAL;
                setTimeout(() => banner.remove(), 3000);
            }
        } else {
            console.log('✅ Aplicación actualizada - Versión ' + VERSION_ACTUAL);
        }
        
        // PROTECCIÓN CONTRA PÉRDIDA DE DATOS
        // Crear respaldo antes de cualquier actualización
        function crearRespaldoEmergencia() {
            const datosImportantes = [
                'empleados', 'sastres', 'senaladores', 'prendas', 
                'facturas', 'clientes', 'config', 'periodosCerrados',
                'historialMensual', 'contadorFacturas', 'modoSincronizacion'
            ];
            
            const respaldo = {};
            let tienedatos = false;
            
            datosImportantes.forEach(clave => {
                const dato = localStorage.getItem(clave);
                if (dato) {
                    respaldo[clave] = dato;
                    tienedatos = true;
                }
            });
            
            if (tienedatos) {
                const timestamp = new Date().toISOString();
                localStorage.setItem('respaldo_' + timestamp, JSON.stringify(respaldo));
                localStorage.setItem('ultimoRespaldo', timestamp);
                console.log('💾 Respaldo creado:', timestamp);
                
                // Mantener solo los últimos 5 respaldos
                const respaldos = Object.keys(localStorage)
                    .filter(k => k.startsWith('respaldo_'))
                    .sort()
                    .reverse();
                    
                if (respaldos.length > 5) {
                    respaldos.slice(5).forEach(k => localStorage.removeItem(k));
                }
            }
        }
        
        // Registrar Service Worker para PWA con detección de actualizaciones
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // Crear respaldo antes de registrar el SW
                crearRespaldoEmergencia();
                
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('✅ Service Worker registrado:', registration);
                        
                        // Verificar actualizaciones cada 30 segundos
                        setInterval(() => {
                            registration.update();
                        }, 30000);
                        
                        // Detectar cuando hay una nueva versión esperando
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            console.log('🔄 Nueva actualización detectada...');
                            
                            // CREAR RESPALDO ANTES DE ACTUALIZAR
                            crearRespaldoEmergencia();
                            
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // Nueva versión disponible
                                    console.log('✨ Nueva versión instalada');
                                    
                                    // Mostrar notificación al usuario
                                    if (confirm('¡Hay una nueva versión disponible! ¿Desea actualizar ahora?\n\n(Sus datos están protegidos con respaldo automático)')) {
                                        newWorker.postMessage({ type: 'SKIP_WAITING' });
                                        window.location.reload();
                                    } else {
                                        console.log('💾 Actualización pospuesta por el usuario');
                                    }
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.log('❌ Error al registrar Service Worker:', error);
                    });
                
                // Detectar cuando el nuevo SW toma control
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    console.log('🔄 Nuevo Service Worker activado');
                    // Crear respaldo final antes de recargar
                    crearRespaldoEmergencia();
                    // Recargar automáticamente
                    window.location.reload();
                });
            });
        }
    </script>
    <script>
        
        // Manejar botón de retroceso en móviles
        window.addEventListener('popstate', function(event) {
            event.preventDefault();
            if (currentUser && currentRole) {
                if (confirm('¿Deseas cerrar sesión?')) {
                    logout();
                } else {
                    // Volver a agregar al historial para que el botón funcione de nuevo
                    history.pushState(null, null, window.location.href);
                }
            } else {
                // Si está en login, no hacer nada o cerrar la app
                if (confirm('¿Deseas salir de la aplicación?')) {
                    window.close();
                } else {
                    history.pushState(null, null, window.location.href);
                }
            }
        });
        
        // Agregar estado inicial al historial
        history.pushState(null, null, window.location.href);
    </script>
    <script src="app.js?v=3.0.9"></script>
</body>
</html>


